<modification>
<id>OpenCart Mobile Framework Lite</id>
<version>v1.7.2</version>
    <vqmver>2.4.1</vqmver>
    <author>omframework.com / braiv.com</author>


<!-- 	*********************************************************
			Common
		*********************************************************
-->
	<file name="catalog/controller/common/header.php">

		<operation>
			<search position="after"><![CDATA[
			$this->language->load('common/header');
			]]></search>
			<add><![CDATA[//OMF start
		if($this->isVisitorMobile()) {
			$this->language->load('omf/common');
		}//OMF  end
		]]>
			</add>
		</operation>

		<operation error="skip">
			<search position="before"><![CDATA[
			$this->data['text_home'] = $this->language->get('text_home');
			]]></search>
			<add><![CDATA[
			//OMF start

				if ($this->config->get('config_mobile_logo') && file_exists(DIR_IMAGE . $this->config->get('config_mobile_logo'))) {
					if (defined('VERSION') && (version_compare(VERSION, '1.5.5', '>=') == true)) {
								$this->data['mobile_logo'] = $server . 'image/' . $this->config->get('config_mobile_logo');
					} else {
								$this->data['mobile_logo'] = $server . $this->config->get('config_mobile_logo');					
					}
				} else {
					$this->data['mobile_logo'] = $this->data['logo'];
				}
				$this->data['text_items_count'] = $this->cart->countProducts();
				$this->data['text_search_link'] = $this->language->get('text_search_link');

				$this->data['text_all_categories'] = $this->language->get('text_all_categories');
				$this->data['all_categories'] = $this->url->link('common/all_categories');

				$this->data['route'] = isset($this->request->get['route']) ? $this->request->get['route'] : '';

			//OMF  end
			]]>
			</add>
		</operation>

	</file>


	<file name="catalog/controller/common/footer.php">
		<operation>
			<search position="after"><![CDATA[
			$this->language->load('common/footer');
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {
			$this->language->load('common/header');
		}
		$this->language->load('omf/common');
		]]>
			</add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$this->language->load('common/footer');
			]]></search>
			<add><![CDATA[
		if (isset($this->request->post['config_mobile_front_page_cat_list'])) {
			$this->data['config_mobile_front_page_cat_list'] = $this->request->post['config_mobile_front_page_cat_list'];
		} else {
			$this->data['config_mobile_front_page_cat_list'] = $this->config->get('config_mobile_front_page_cat_list');
		}
		]]>
			</add>
		</operation>

		<operation>
			<search position="after" index="1"><![CDATA[
			'text_newsletter'
			]]></search>
			<add><![CDATA[		//Required by the stuff coming from the header.php
		$this->data['text_language'] = $this->language->get('text_language');
    	$this->data['text_currency'] = $this->language->get('text_currency');
		$this->data['text_home'] = $this->language->get('text_home');
		$this->data['text_wishlist'] = sprintf($this->language->get('text_wishlist'), (isset($this->session->data['wishlist']) ? count($this->session->data['wishlist']) : 0));
		$this->data['text_cart'] = $this->language->get('text_cart');
		$this->data['text_search'] = $this->language->get('text_search');
		$this->data['text_search_link'] = $this->language->get('text_search_link');
		$this->data['text_checkout'] = $this->language->get('text_checkout');
		$this->data['text_welcome'] = sprintf($this->language->get('text_welcome'), $this->url->link('account/login', '', 'SSL'), $this->url->link('account/register', '', 'SSL'));
		$this->data['text_logged'] = sprintf($this->language->get('text_logged'), $this->url->link('account/account', '', 'SSL'), $this->customer->getFirstName(), $this->url->link('account/logout', '', 'SSL'));

		//For the contact submenu
		$this->language->load('information/contact');
		$this->data['text_address'] = str_replace(':','',$this->language->get('text_address'));
		$this->data['text_enquiry'] = str_replace(':','',$this->language->get('entry_enquiry'));
		$this->data['text_call'] = $this->language->get('text_call');

		//OMF specific
		$this->data['text_all_categories'] = $this->language->get('text_all_categories');
		$this->data['text_top'] = $this->language->get('text_top');
		$this->data['text_view'] = $this->language->get('text_view');
		$this->data['text_mobile'] = $this->language->get('text_mobile');
		$this->data['text_standard'] = $this->language->get('text_standard');
		if (defined('VERSION') && (version_compare(VERSION, '1.5.3', '<') == true)) {
			$this->data['button_apply'] = $this->language->get('button_apply');
		}

		if (isset($this->request->get['filter_name'])) {
			$this->data['filter_name'] = $this->request->get['filter_name'];
		} else {
			$this->data['filter_name'] = '';
		}

		$this->data['home'] = $this->url->link('common/home');
		$this->data['wishlist'] = $this->url->link('account/wishlist');
		$this->data['logged'] = $this->customer->isLogged();
		$this->data['account'] = $this->url->link('account/account', '', 'SSL');
		$this->data['cart'] = $this->url->link('checkout/cart');
		$this->data['checkout'] = $this->url->link('checkout/login', '', 'SSL');

		$this->data['address'] = urlencode(str_replace('\n', '+', $this->config->get('config_address')));
    	$this->data['telephone'] = $this->config->get('config_telephone');

		$this->data['google_analytics'] = html_entity_decode($this->config->get('config_google_analytics'), ENT_QUOTES, 'UTF-8');

		$this->data['text_blog']    = $this->language->get('text_blog');
		
		$this->load->model('omf/omf');
		$this->data['blog'] = $this->model_omf_omf->isBlogManagerInstalled();

		$this->data['tablet'] = $this->isVisitorTablet();

]]>			</add>
		</operation>

		<operation>
			<search position="after" index="1"><![CDATA[
			data['powered']
			]]></search>
			<add><![CDATA[		//Trigger only if client is on a mobile device
		if($this->isVisitorMobile()) {
			if (defined('VERSION') && (version_compare(VERSION, '1.5.2', '<') == true)) {
				$this->data['action'] = $this->url->link('common/home');

				if (!isset($this->request->get['route'])) {
					$this->data['redirect'] = $this->url->link('common/home');
				} else {
					$data = $this->request->get;

					unset($data['_route_']);

					$route = $data['route'];

					unset($data['route']);

					$url = '';

					if ($data) {
						$url = '&' . urldecode(http_build_query($data, '', '&'));
					}

					$this->data['redirect'] = $this->url->link($route, $url);
				}

				//Languages
				if (($this->request->server['REQUEST_METHOD'] == 'POST') && isset($this->request->post['language_code'])) {
					$this->session->data['language'] = $this->request->post['language_code'];

					if (isset($this->request->post['redirect'])) {
						$this->redirect($this->request->post['redirect']);
					} else {
						$this->redirect($this->url->link('common/home'));
					}
				}

				$this->data['language_code'] = $this->session->data['language'];

				$this->load->model('localisation/language');

				$this->data['languages'] = array();

				$results = $this->model_localisation_language->getLanguages();

				foreach ($results as $result) {
					if ($result['status']) {
						$this->data['languages'][] = array(
							'name'  => $result['name'],
							'code'  => $result['code'],
							'image' => $result['image']
						);
					}
				}

				//Currencies
				if (($this->request->server['REQUEST_METHOD'] == 'POST') && isset($this->request->post['currency_code'])) {
					$this->currency->set($this->request->post['currency_code']);

					unset($this->session->data['shipping_methods']);
					unset($this->session->data['shipping_method']);

					if (isset($this->request->post['redirect'])) {
						$this->redirect($this->request->post['redirect']);
					} else {
						$this->redirect($this->url->link('common/home'));
					}
				}

				$this->data['currency_code'] = $this->currency->getCode();

				$this->load->model('localisation/currency');

				 $this->data['currencies'] = array();

				$results = $this->model_localisation_currency->getCurrencies();

				foreach ($results as $result) {
					if ($result['status']) {
						$this->data['currencies'][] = array(
							'title'        => $result['title'],
							'code'         => $result['code'],
							'symbol_left'  => $result['symbol_left'],
							'symbol_right' => $result['symbol_right']
						);
					}
				}
			// Menu
			//$this->data['routeDebug'] = $this->request->get['route'];
			$route = empty($this->request->get['route']) ? 'common/home' : $this->request->get['route'];
			$this->data['route'] = $route;

			} else {

				// Menu
				//$this->data['routeDebug'] = $this->request->get['route'];
				$route = empty($this->request->get['route']) ? 'common/home' : $this->request->get['route'];
				$this->data['route'] = $route;

			}

			if($route == 'common/home' ) { //If on homepage show the categories. Else hide them.
				$this->load->model('catalog/category');
				$this->load->model('catalog/product');

				$this->data['categories'] = array();

				$categories = $this->model_catalog_category->getCategories(0);

				foreach ($categories as $category) {
					if($this->config->get('config_mobile_display_top_cats') == true) {
						if ($category['top']){
							$children_data = array();

							$children = $this->model_catalog_category->getCategories($category['category_id']);

							foreach ($children as $child) {
								$data = array(
									'filter_category_id'  => $child['category_id'],
									'filter_sub_category' => true
								);

								#$product_total = $this->model_catalog_product->getTotalProducts($data);

								$children_data[] = array(
									'name'  => $child['name'] /*. ' (' . $product_total . ')'*/,
									'href'  => $this->url->link('product/category', 'path=' . $category['category_id'] . '_' . $child['category_id'])
								);
							}

							// Level 1
							$this->data['categories'][] = array(
								'name'     => $category['name'],
								'children' => $children_data,
								'column'   => $category['column'] ? $category['column'] : 1,
								'href'     => $this->url->link('product/category', 'path=' . $category['category_id'])
							);
						}
					} else {
						$children_data = array();

						$children = $this->model_catalog_category->getCategories($category['category_id']);

						foreach ($children as $child) {
							$data = array(
								'filter_category_id'  => $child['category_id'],
								'filter_sub_category' => true
							);

							#$product_total = $this->model_catalog_product->getTotalProducts($data);

							$children_data[] = array(
								'name'  => $child['name'] /*. ' (' . $product_total . ')'*/,
								'href'  => $this->url->link('product/category', 'path=' . $category['category_id'] . '_' . $child['category_id'])
							);
						}

						// Level 1
						$this->data['categories'][] = array(
							'name'     => $category['name'],
							'children' => $children_data,
							'column'   => $category['column'] ? $category['column'] : 1,
							'href'     => $this->url->link('product/category', 'path=' . $category['category_id'])
						);
					}

				}

				$this->data['all_categories'] = $this->url->link('common/all_categories');
			}
		}

			if (defined('VERSION') && (version_compare(VERSION, '1.5.2', '>=') == true)) {
			$this->children = array(
				'module/language',
				'module/currency',
			);
			}
				]]>
			</add>
		</operation>
	</file>

	<file name="catalog/controller/common/content_top.php">
		<operation error="log">
			<search position="after"><![CDATA[
			foreach ($extensions as $extension) {
			]]></search>
			<add><![CDATA[//OMF start
			$isMobileExtension = false;

			if(strpos($extension['code'], '_mobile') !== false){
				$isMobileExtension = true;
			}//OMF end ]]>
			</add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
			if ($modules) {
			]]></search>
			<add>
			<![CDATA[			if($this->isVisitorMobile()) { //OMF If our client is a mobile device ]]>
			</add>
		</operation>

		<!-- 
		OC Advanced Modules REMOVE ME -->
		<operation error="log">
			<search position="replace" regex="true" offset="8"><![CDATA[
			~if \(\$module\['layout_id'\] == \$layout_id && \$module\['position'\] == 'content_(\w*)' && \$module\['status'\]\) {~
			]]></search>
			<add><![CDATA[//OMF start
						if ($module['layout_id'] == $layout_id && $module['position'] == 'content_$1' && $module['status'] && $isMobileExtension) { //load only mobile extensions
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			} else { // Load extensions normally
				if ($modules) {
					foreach ($modules as $module) {
						if ($module['layout_id'] == $layout_id && $module['position'] == 'content_$1' && $module['status'] && !$isMobileExtension) { //omitting the mobile ones
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			}//OMF end
			]]>
			</add>
		</operation>
		<!-- OC Advanced Modules REMOVE ME
		-->
			
	</file>

	<file name="catalog/controller/common/content_bottom.php">
		<operation error="log">
			<search position="after"><![CDATA[
			foreach ($extensions as $extension) {
			]]></search>
			<add><![CDATA[//OMF start
			$isMobileExtension = false;

			if(strpos($extension['code'], '_mobile') !== false){
				$isMobileExtension = true;
			}//OMF end ]]>
			</add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
			if ($modules) {
			]]></search>
			<add>
			<![CDATA[			if($this->isVisitorMobile()) { //OMF If our client is a mobile device ]]>
			</add>
		</operation>

		<!-- 
		OC Advanced Modules REMOVE ME -->
		<operation error="log">
			<search position="replace" regex="true" offset="8"><![CDATA[
			~if \(\$module\['layout_id'\] == \$layout_id && \$module\['position'\] == 'content_(\w*)' && \$module\['status'\]\) {~
			]]></search>
			<add><![CDATA[//OMF start
						if ($module['layout_id'] == $layout_id && $module['position'] == 'content_$1' && $module['status'] && $isMobileExtension) { //load only mobile extensions
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			} else { // Load extensions normally
				if ($modules) {
					foreach ($modules as $module) {
						if ($module['layout_id'] == $layout_id && $module['position'] == 'content_$1' && $module['status'] && !$isMobileExtension) { //omitting the mobile ones
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			}//OMF end
			]]>
			</add>
		</operation>
		<!-- OC Advanced Modules REMOVE ME
		-->
			
	</file>

	<file name="catalog/controller/common/column_left.php">
		<operation>
			<search position="after">
			<![CDATA[ foreach ($extensions as $extension) {]]>
			</search>
			<add><![CDATA[//OMF start
			$isMobileExtension = false;

			if(strpos($extension['code'], '_mobile') !== false){
				$isMobileExtension = true;
			}//OMF end ]]>
			</add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
			if ($modules) {
			]]></search>
			<add>
			<![CDATA[if($this->isVisitorMobile()) { //If our client is a mobile device ]]>
			</add>
		</operation>

		<!-- 
		OC Advanced Modules REMOVE ME -->
		<operation error="log">
			<search position="replace" regex="true" offset="8"><![CDATA[
			~if \(\$module\['layout_id'\] == \$layout_id && \$module\['position'\] == 'column_(\w*)' && \$module\['status'\]\) {~
			]]></search>
			<add><![CDATA[//OMF start
						if ($module['layout_id'] == $layout_id && $module['position'] == 'column_$1' && $module['status'] && $isMobileExtension) { //load only mobile extensions
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			} else { // Load extensions normally
				if ($modules) {
					foreach ($modules as $module) {
						if ($module['layout_id'] == $layout_id && $module['position'] == 'column_$1' && $module['status'] && !$isMobileExtension) { //omitting the mobile ones
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			}//OMF end
			]]>
			</add>
		</operation>
		<!-- OC Advanced Modules REMOVE ME
		-->
	</file>

	<file name="catalog/controller/common/column_right.php">
		<operation>
			<search position="after">
			<![CDATA[ foreach ($extensions as $extension) {]]>
			</search>
			<add><![CDATA[//OMF start
			$isMobileExtension = false;

			if(strpos($extension['code'], '_mobile') !== false){
				$isMobileExtension = true;
			}//OMF end ]]>
			</add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
			if ($modules) {
			]]></search>
			<add>
			<![CDATA[if($this->isVisitorMobile()) { //If our client is a mobile device ]]>
			</add>
		</operation>

		<!-- 
		OC Advanced Modules REMOVE ME -->
		<operation error="log">
			<search position="replace" regex="true" offset="8"><![CDATA[
			~if \(\$module\['layout_id'\] == \$layout_id && \$module\['position'\] == 'column_(\w*)' && \$module\['status'\]\) {~
			]]></search>
			<add><![CDATA[//OMF start
						if ($module['layout_id'] == $layout_id && $module['position'] == 'column_$1' && $module['status'] && $isMobileExtension) { //load only mobile extensions
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			} else { // Load extensions normally
				if ($modules) {
					foreach ($modules as $module) {
						if ($module['layout_id'] == $layout_id && $module['position'] == 'column_$1' && $module['status'] && !$isMobileExtension) { //omitting the mobile ones
							$module_data[] = array(
								'code'       => $extension['code'],
								'setting'    => $module,
								'sort_order' => $module['sort_order']
							);
						}
					}
				}
			}//OMF end
			]]>
			</add>
		</operation>
		<!-- OC Advanced Modules REMOVE ME
		-->
	</file>


<!-- 	*********************************************************
			Checkout
		********************************************************* -->

	<!-- 	** END ********************************************* -->

	<file name="catalog/controller/checkout/cart.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->data['button_reward']]></search>
			<add><![CDATA[
			if($this->isVisitorMobile()) {
				$this->language->load('omf/common');
				$this->data['button_apply'] = $this->language->get('button_apply');
			}	]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[
			$this->language->load('checkout/cart');
			]]></search>
			<add><![CDATA[
		if ($this->isVisitorMobile()) {
			$this->data['logged'] = $this->customer->isLogged();
		}
			]]>
			</add>
		</operation>

 		<operation error="skip">
			<search position="replace" regex="true"><![CDATA[
			~\$json\['total'\] = (.*);~
			]]></search>
			<add><![CDATA[
			if(!$this->isVisitorMobile()) {
				$json['total'] = $1;
			} else {
				/*if(isset($_SERVER['HTTP_REFERER'])) {
					$route = $_SERVER['HTTP_REFERER'];
				} else {
					$route = $this->url->link('checkout/cart') ;
				}

				$this->redirect($route);			*/ // Uncomment if you want adding to cart to redirect back to the page you clicked the button from
				$this->redirect($this->url->link('checkout/cart'));
			}
			]]></add>
		</operation>

		<operation error="skip"> <!-- v1.5.1.3 -->
			<search position="after"><![CDATA[
			$json['error'][$product_option['product_option_id']] = sprintf($this->language->get('error_required'), $product_option['name']);
			]]></search>
			<add><![CDATA[
						$errors[$product_option['product_option_id']] = $json['error'][$product_option['product_option_id']];
			]]></add>
		</operation>

		<operation error="skip"> <!-- v1.5.2+ -->
			<search position="after"><![CDATA[
			$json['error']['option'][$product_option['product_option_id']] = sprintf($this->language->get('error_required'), $product_option['name']);
			]]></search>
			<add><![CDATA[
						$errors[$product_option['product_option_id']] = $json['error']['option'][$product_option['product_option_id']];
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$this->cart->add($this->request->post['product_id'], $quantity, $option
			]]></search>
			<add><![CDATA[
				unset($this->session->data['errors']);
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$json['redirect'] = str_replace('&amp;', '&', $this->url->link('product/product', 'product_id=' . $this->request->post['product_id']));
			]]></search>
			<add><![CDATA[
				if($this->isVisitorMobile()) {
					$this->session->data['errors'] = $errors;
					$this->redirect($json['redirect'] . "#options");
				}
			]]></add>
		</operation>

		<operation error="skip"> <!-- Pretty images on retina displays v.1.5.2+ -->
            <search><![CDATA[
            $image = $this->model_tool_image->resize($product['image'], $this->config->get('config_image_cart_width'), $this->config->get('config_image_cart_height'));
            ]]></search>
            <add><![CDATA[
				if($this->isVisitorMobile()) {
						$resolution = getResolution();
						$image = $this->model_tool_image->resize($product['image'], $resolution/2, $resolution/2, 'r');
				} else {
						$image = $this->model_tool_image->resize($product['image'], $this->config->get('config_image_cart_width'), $this->config->get('config_image_cart_height'));
				}
	            ]]></add>
	    </operation>
		<operation error="skip"> <!-- Pretty images on retina displays < v.1.5.2 -->
            <search><![CDATA[
			$image = $this->model_tool_image->resize($result['image'], $this->config->get('config_image_cart_width'), $this->config->get('config_image_cart_height'));
            ]]></search>
            <add><![CDATA[
				if($this->isVisitorMobile()) {
						$resolution = getResolution();
						$image = $this->model_tool_image->resize($result['image'], $resolution/2, $resolution/2, 'r');
				}else {
						$image = $this->model_tool_image->resize($result['image'], $this->config->get('config_image_cart_width'), $this->config->get('config_image_cart_height'));
				}
	            ]]></add>
	    </operation>
	</file>

	<file name="catalog/controller/checkout/login.php">
		<operation>
			<search regex="true" position="after"><![CDATA[
			~.*'guest_checkout'.*~
			]]></search>
			<add><![CDATA[ //OMF start
			$this->data['guest_checkout_url'] = $this->url->link('checkout/guest');
			$this->data['register_checkout_url'] = $this->url->link('checkout/register');
			//OMF end]]></add>
		</operation>

	</file>

	<file name="catalog/controller/checkout/guest*.php"> <!-- This patches guest.php on 1513 and guest_shipping.php on 152+ -->
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_select'] = $this->language->get('text_select');
			]]></search>
			<add><![CDATA[
			$this->data['text_your_details'] = $this->language->get('text_your_details');
			$this->data['text_your_address'] = $this->language->get('text_your_address');
				]]>
			</add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/guest.php"> 
		<operation>
			<search position="after"><![CDATA[
			$this->data['entry_company'] = $this->language->get('entry_company');
			]]></search>
			<add><![CDATA[
			if (defined('VERSION') && (version_compare(VERSION, '1.5.4', '>=') == true) && $this->isVisitorMobile()) {
				$this->language->load('omf/checkout');
				$this->data['entry_account'] = $this->language->get('entry_account');
			}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/register.php"> 
		<operation>
			<search position="after"><![CDATA[
			$this->data['entry_company'] = $this->language->get('entry_company');
			]]></search>
			<add><![CDATA[
			if (defined('VERSION') && (version_compare(VERSION, '1.5.3', '>=') == true) && (version_compare(VERSION, '1.5.4', '<') == true) && $this->isVisitorMobile()) {
				$this->language->load('omf/checkout');
				$this->data['entry_customer_group'] = $this->language->get('entry_customer_group');
			}
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			$this->model_account_customer->addCustomer($this->request->post);
			]]></search>
			<add><![CDATA[
			$address_id = $this->model_account_customer->addCustomer($this->request->post);
			$this->session->data['shipping_address_id'] = $address_id;
			$this->session->data['payment_address_id'] = $address_id;
			]]></add>
		</operation>	
	</file>

	<file name="catalog/controller/checkout/confirm.php">
  		<operation error="skip">
			<search position="after"><![CDATA[
			$this->data['column_total'] = $this->language->get('column_total');
			]]></search>
			<add><![CDATA[
			if ($this->isVisitorMobile()) {
				$this->language->load('product/product');
				$this->data['text_qty'] = str_replace(':', '', $this->language->get('text_qty'));
			}]]>
			</add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/success.php">
  		<operation>
			<search><![CDATA[
			$this->data['text_message'] = sprintf($this->language->get('text_customer'), $this->url->link('account/account', '', 'SSL'), $this->url->link('account/order', '', 'SSL'), $this->url->link('account/download', '', 'SSL'), $this->url->link('information/contact'));
			]]></search>
			<add><![CDATA[$this->data['text_message'] = sprintf($this->language->get('text_guest'), $this->url->link('information/contact'));
			]]></add>
		</operation>
	</file>


<!-- 	*********************************************************
			Product
		*********************************************************
	 	** Mass replace on product 	************************* -->
	<file name="catalog/controller/product/*.php">
		<operation error="skip" >
			<search position="after"><![CDATA[
			$json = array();
			]]></search>
			<add><![CDATA[
		$errors = array();
			]]></add>
		</operation>

		<!-- Convert all errors from json to the errors array, everywhere -->
		<operation error="skip" >
			<search position="replace" regex="true"><![CDATA[
			~\$json\['error'\]\['(\w*)'\] = (.*);~
			]]></search>
			<add><![CDATA[$json['error']['$1'] = $2;
					$errors['$1'] = $2;]]></add>
		</operation>

		<operation error="skip" >
			<search position="replace" regex="true"><![CDATA[
			~\$json\['error'\] = (.*);~
			]]></search>
			<add><![CDATA[$json['error'] = $1;
					$errors = $1;]]></add>
		</operation>

		<operation error="skip">
			<search position="replace" regex="true"><![CDATA[
			~\$image = \$this\-\>model_tool_image\-\>resize\(\$result\['image'\], \$this\-\>config\-\>get\('config_image_(\w*)_width'\), \$this\-\>config\-\>get\('config_image_(\w*)_height'\)\);~
			]]></search>
			<add><![CDATA[
				if($this->isVisitorMobile()) {
						$resolution = getResolution();
						$image = $this->model_tool_image->resize($result['image'], $resolution, $resolution, 'r');
				}else {
						$image = $this->model_tool_image->resize($result['image'], $this->config->get('config_image_$1_width'), $this->config->get('config_image_$2_height'));
				}
			]]></add>
		</operation>
	</file>
	<!-- 	** END ********************************************** -->

	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="after"><![CDATA[
			$this->load->model('catalog/category');
			]]></search>
			<add><![CDATA[
		if(isset($this->session->data['errors'])) {
			$this->data['errors'] = $this->session->data['errors'];
		}
		if($this->isVisitorMobile()) {
			$this->language->load('omf/common');
		}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$this->data['text_tags'] = $this->language->get('text_tags');
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {
			$this->data['text_close'] = $this->language->get('text_close');
		}
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			$this->data['thumb'] = $this->model_tool_image->resize($product_info['image'], $this->config->get('config_image_thumb_width'), $this->config->get('config_image_thumb_height'));
			]]></search>
			<add><![CDATA[
			if($this->isVisitorMobile()) {
				$resolution = getResolution();
				$this->data['thumb'] = $this->model_tool_image->resize($product_info['image'], $resolution, $resolution, 'r');
			} else {
				$this->data['thumb'] = $this->model_tool_image->resize($product_info['image'], $this->config->get('config_image_thumb_width'), $this->config->get('config_image_thumb_height'));
			}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$this->data['images'] = array();
			]]></search>
			<add><![CDATA[
			$this->data['slide_images'] = array();
			]]></add>
		</operation>

    	<operation>
			<search position="before"><![CDATA[
			$this->data['images'][] = array(
			]]></search>
			<add><![CDATA[
			if($this->isVisitorMobile()) {
				$resolution = getResolution();
				$this->data['slide_images'][] = array(
				'popup' => $this->model_tool_image->resize($result['image'], $resolution, $resolution, 'r'),
				'thumb' => $this->model_tool_image->resize($result['image'], $resolution, $resolution, 'r')
				);
				$this->data['images'][] = array(
					'popup' => $this->model_tool_image->resize($result['image'], $this->config->get('config_image_popup_width'), $this->config->get('config_image_popup_height'), 'r'),
					'thumb' => $this->model_tool_image->resize($result['image'], $this->config->get('config_image_additional_width'), $this->config->get('config_image_additional_height'), 'r')
				);
			} else {
			]]></add>
		</operation>

    	<operation>
			<search position="before" index="1"><![CDATA[
			if (($this->config->get('config_customer_price')
			]]></search>
			<add><![CDATA[
		}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			if ($product_info['quantity'] <= 0) {
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile() && $this->config->get('config_disable_addtocart_outofstock')) {
			$this->data['out_of_stock'] = true;
		}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			'price'   	 => $price,
			]]></search>
			<add><![CDATA[
			'out_of_stock'   => ($result['quantity'] <=0 && $this->config->get('config_disable_addtocart_outofstock')) ? true : false,
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/product/category.php">
		<operation>
			<search position="after"><![CDATA[
			$this->language->load('product/category');
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {
			$this->language->load('omf/common');
		}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			$this->data['text_limit'] = $this->language->get('text_limit');
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {

			$this->data['text_more'] = $this->language->get('text_more');
		}
			]]></add>
		</operation>

		<operation>
			<search position="replace" regex="true"><![CDATA[
			~\$this\-\>data\['thumb'\] = \$this\-\>model_tool_image\-\>resize\(\$(\w*)_info\['image'\], \$this\-\>config->get\('config_image_(\w*)_width'\), \$this\-\>config\-\>get\('config_image_(\w*)_height'\)\);~
			]]></search>
			<add><![CDATA[
			if($this->isVisitorMobile()) {
				$resolution = getResolution();
				$this->data['thumb'] = $this->model_tool_image->resize($$1_info['image'], $resolution, $resolution, 'r');
			} else {
				$this->data['thumb'] = $this->model_tool_image->resize($$1_info['image'], $this->config->get('config_image_$2_width'), $this->config->get('config_image_$3_height'));
			}
			]]></add>
		</operation>

		<operation>
			<search position="after" regex="true"><![CDATA[
			~'price'(\s*)=>(\s*)\$price,~
			]]></search>
			<add><![CDATA[
			'out_of_stock'   => ($result['quantity'] <=0 && $this->config->get('config_disable_addtocart_outofstock')) ? true : false,
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/product/search.php">
		<operation>
			<search position="after" regex="true"><![CDATA[
			~'price'(\s*)=>(\s*)\$price,~
			]]></search>
			<add><![CDATA[
			'out_of_stock'   => ($result['quantity'] <=0 && $this->config->get('config_disable_addtocart_outofstock')) ? true : false,
			]]></add>
		</operation>
	</file>


<!-- 	*********************************************************
			Misc
		********************************************************* -->
	<file name="catalog/view/theme/*/template/common/footer.tpl">
		<operation error="skip">
			<search position="before">
			<![CDATA[</body> ]]>
			</search>
			<!--Pinshop blank screen fix-->
			<ignoreif><![CDATA[
			echo str_replace($break,"&nbsp;",$powered);
			]]></ignoreif>
			<add><![CDATA[
			<span id="switch_mobile"><?php echo $text_view; ?> <a href="<?php if (strpos($_SERVER['QUERY_STRING'], 'view=desktop') === false) {
									if ($tablet) {
										echo $_SERVER['REQUEST_URI'] . (empty($_SERVER['QUERY_STRING']) ? '?view=tablet' : '&view=tablet');
									} else {
										echo $_SERVER['REQUEST_URI'] . (empty($_SERVER['QUERY_STRING']) ? '?view=mobile' : '&view=mobile');
									}
								} else {
									if ($tablet) {
										echo str_replace('view=desktop', 'view=tablet', $_SERVER['REQUEST_URI']);
									} else {
										echo str_replace('view=desktop', 'view=mobile', $_SERVER['REQUEST_URI']);
									}
								} ?>" rel="nofollow"><?php echo $text_mobile; ?></a> / <?php echo $text_standard; ?></span>
			]]></add>
		</operation>

		<operation error="skip"> <!-- This puts the "View mobile switch on the shoppica theme -->
			<search position="after">
			<![CDATA[<p id="copy"> ]]>
			</search>
			<add><![CDATA[
			<span id="switch_mobile"><?php echo $text_view; ?> <a href="<?php if (strpos($_SERVER['QUERY_STRING'], 'view=desktop') === false) {
									if (isTablet()) {
										echo $_SERVER['REQUEST_URI'] . (empty($_SERVER['QUERY_STRING']) ? '?view=tablet' : '&view=tablet');
									} else {
										echo $_SERVER['REQUEST_URI'] . (empty($_SERVER['QUERY_STRING']) ? '?view=mobile' : '&view=mobile');
									}
								} else {
									if (isTablet()) {
										echo str_replace('view=desktop', 'view=tablet', $_SERVER['REQUEST_URI']);
									} else {
										echo str_replace('view=desktop', 'view=mobile', $_SERVER['REQUEST_URI']);
									}
								} ?>" rel="nofollow"><?php echo $text_mobile; ?></a> / <?php echo $text_standard; ?></span>
			]]></add>
		</operation>
	</file>

	<file name="catalog/model/tool/image.php">
		<operation error="skip">
			<search position="replace"><![CDATA[
			public function resize($filename, $width, $height) {
			]]></search>
			<add><![CDATA[
			//OMF proper responsive scalling without BG
			public function resize($filename, $width, $height, $type = '') {
			//End OMF
			]]></add>
		</operation>

		<operation error="skip">
			<search position="replace" regex="true"><![CDATA[
			~\$new_image = 'cache\/' . (\w*)substr\(\$filename, 0, (\w*)strrpos\(\$filename, '\.'\)\) \. '\-' . \$width \. 'x' . \$height \. '\.' \. \$extension;~
			]]></search>
			<add><![CDATA[
			//OMF proper responsive scalling without BG
			$new_image = 'cache/' . utf8_substr($filename, 0, utf8_strrpos($filename, '.')) . '-' . $width . 'x' . $height . $type .'.' . $extension;
			//End OMF
			]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
			$image->resize($width, $height);
			]]></search>
			<add><![CDATA[
			//OMF proper responsive scalling without BG
			$image->resize($width, $height, $type);
			//End OMF
			]]></add>
		</operation>
	</file>

<!-- 	*********************************************************
			Account
		*********************************************************
-->
	<file name="catalog/controller/account/wishlist.php">
		<operation error="skip"> <!-- Pretty images on retina displays < v.1.5.2 -->
            <search><![CDATA[
			$image = $this->model_tool_image->resize($product_info['image'], $this->config->get('config_image_wishlist_width'), $this->config->get('config_image_wishlist_height'));
            ]]></search>
            <add><![CDATA[
				if($this->isVisitorMobile()) {
						$resolution = getResolution();
						$image = $this->model_tool_image->resize($product_info['image'], $resolution/2, $resolution/2, 'r');
				} else {
						$image = $this->model_tool_image->resize($product_info['image'], $this->config->get('config_image_wishlist_width'), $this->config->get('config_image_wishlist_height'));
				}
	            ]]></add>
	    </operation>

	    <operation error="skip">
            <search><![CDATA[
			$this->data['button_back'] = $this->language->get('button_back');
            ]]></search>
            <add><![CDATA[
			$this->data['button_remove'] = $this->language->get('button_remove');	
	        ]]></add>
	    </operation>
	</file>

	<file name="catalog/controller/account/order.php">
		<operation error="skip">
		<search position="after"><![CDATA[
		$this->data['column_total'] = $this->language->get('column_total');
		]]></search>
		<add><![CDATA[
			if ($this->isVisitorMobile()) {
				$this->language->load('product/product');
				$this->data['text_qty'] = str_replace(':', '', $this->language->get('text_qty'));
			}]]>
		</add>
	</operation>
	</file>

	<file name="catalog/model/account/customer.php">
		<operation error="skip">
			<search position="before" offset="2"><![CDATA[
			public function editCustomer($data) {
			]]></search>
			<add><![CDATA[
		return $address_id;
			]]></add>
		</operation>
	</file>

<!-- 	*********************************************************
			Information
		********************************************************* -->

	<file name="catalog/controller/information/contact.php">
		<operation error="skip" >
			<search position="after"><![CDATA[
			$this->language->load('information/
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {
			$this->language->load('omf/common');
		}
		]]>
			</add>
		</operation>
	</file>

	<file name="catalog/controller/information/information.php">
		<operation error="skip" >
			<search position="after"><![CDATA[
			$this->language->load('information/
			]]></search>
			<add><![CDATA[
		if($this->isVisitorMobile()) {
			$this->language->load('omf/common');
		}
		]]>
			</add>
		</operation>
	</file>
	<!-- 	** END ********************************************** -->
</modification>
